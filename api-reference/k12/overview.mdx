---
title: "K12 Tools & API Overview"
description: "Conceptual map of the K12 Mastra surface for developers"
---

<link rel="stylesheet" href="/styles.css" />

<OpenAPI src="/api-reference/openapi.json" />

## Runtime surface

- **Target**: `MASTRA_TARGET=k12` loads `src/mastra/index.k12.ts`, wiring the K12 agent, workflows, and tools.
- **Agent**: Registry `eop-k12-safety-agent`, profile `k12-safety-agent`. Instructions and LLM overrides (model/deployment/temperature/top-p/etc.) come from Agent Profiles (`agentProfilesService`).
- **Workflow**: `k12-annex-workflow` orchestrates the annex editing run: normalize → request log insert → monitoring insert → agent call → response log update → monitoring finalize.

## Tool catalog (conceptual)

All tools are available via the Mastra tool registry and exposed over `/api/tools/{toolId}/execute` (HTTP payloads mirror the tool schemas).

- **Workflow entry**
  - `k12-annex-editing-kickoff`: Validates form + prompt input, inserts a job row, starts the annex workflow; supports `waitForResult` for sync/async.
  - `k12-annex-editing-status`: Reads `log_Jobs` to report status per `requestId` list.
  - `k12-annex-editing-result`: Reads `log_Jobs` for final payload; returns `isEdit`, status, message.
- **Logging + monitoring**
  - `k12-insert-task-request-log`: Writes normalized payloads to `K12SAFETY.log_EOP_TaskRequests`.
  - `k12-insert-task-in-monitoring-table`: Seeds `log_EOP_TaskStatus` with `processing` (or other allowed status).
  - `k12-update-task-request-response`: Persists model response fields back into the request log.
  - `k12-update-task-status`: Updates monitoring rows by `SessionID` + `RequestID`.
  - `k12-cancel-task-request`: Marks request + status rows as `cancelled`; optionally cancels live workflow runs when enabled.
- **Lookup**
  - `k12-lkp-task-status-by-session-or-request`: Returns the latest status row for a request (optionally filtered by session).
  - `k12-lkp-task-request-result`: Returns the latest stored response (`status`, `message`, `isEdit`) from `log_EOP_TaskRequests`.
- **Plan metadata**
  - `k12-get-emergency-operation-plan-snapshot`: Calls the K12 Safety REST API for snapshot metadata; supports paging and latest-only.

<AccordionGroup>
<Accordion title="k12-annex-editing-kickoff">
Kick off the annex workflow, seed `log_Jobs`, and optionally wait for completion.

**Input**
- `emergencyOperationPlanId` (string, required)
- `emergencyOperationPlanConfigurationId` (string, optional)
- `userId`, `roleId` (strings, required)
- `form.name` (string, optional), `form.field.group|name|content` (strings, optional; content can be empty to indicate prompt-only)
- `prompt` (string, optional)
- `requestId`, `sessionId` (UUID strings, optional; generated if omitted)
- `waitForResult` (boolean, default false)

**Output**
- `accepted` with `requestId`, `sessionId`, `workflowRunId?`, `message` (when async)
- `success` with `statusHistory[]`, `agentResponse`, `responsePayloadJson`, `requestLogId`, `monitoringRowId`, `responseStatus`, `isEdit`, `message` (when waiting)
</Accordion>

<Accordion title="k12-annex-editing-status">
Return job status rows from `log_Jobs` for a list of request IDs.

**Input**: `requestIds[]` (strings)

**Output**: array of `{ requestId, sessionId, status }`
</Accordion>

<Accordion title="k12-annex-editing-result">
Fetch the stored result for a request from `log_Jobs`.

**Input**: `requestId` (string)

**Output**: `{ requestId, sessionId, status, message, isEdit }`
</Accordion>

<Accordion title="k12-insert-task-request-log">
Insert the normalized workflow payload into `log_EOP_TaskRequests`.

**Input**
- `taskName` (string, default "K12 Annex Workflow")
- `requestId`, `sessionId` (strings, required)
- `emergencyOperationPlanId`, `emergencyOperationPlanConfigurationId`, `userId`, `roleId` (optional strings)
- `form.name`, `form.field.group|name|content` (optional strings)
- `prompt`, `workflowRunId` (optional strings)

**Output**: inserted row with IDs, request metadata, and nullable response fields.
</Accordion>

<Accordion title="k12-insert-task-in-monitoring-table">
Insert a status row into `log_EOP_TaskStatus`.

**Input**: `taskName` (default), `sessionId`, `requestId`, `status` (one of `accepted|processing|success|error|cancelled`), `message?`, `workflowRunId?`

**Output**: inserted monitoring row.
</Accordion>

<Accordion title="k12-update-task-request-response">
Update the request log with the model response.

**Input**: `requestId`, `sessionId`, `responseStatus` (default "success"), `responseMessage`, `responseIsEdit?`, `rawResponseJson?`, `responsePayloadJson?`

**Output**: updated request row with response fields populated.
</Accordion>

<Accordion title="k12-update-task-status">
Update monitoring status for a request/session.

**Input**: `sessionId`, `requestId`, `status` (accepted|processing|success|error|cancelled)

**Output**: updated monitoring row.
</Accordion>

<Accordion title="k12-cancel-task-request">
Mark request + status rows as cancelled and optionally cancel in-flight workflow runs (`K12_ENABLE_WORKFLOW_CANCELLATION=true`).

**Input**: `requestId`

**Output**: `{ status: "success" | "error", message? }`
</Accordion>

<Accordion title="k12-lkp-task-status-by-session-or-request">
Fetch latest status from `log_EOP_TaskStatus`.

**Input**: `requestId` (required), `sessionId?`

**Output**: `{ requestId, sessionId, status }`
</Accordion>

<Accordion title="k12-lkp-task-request-result">
Fetch latest stored response from `log_EOP_TaskRequests`.

**Input**: `requestId` (required), `sessionId?`

**Output**: `{ requestId, sessionId, status, message, isEdit } | null`
</Accordion>

<Accordion title="k12-get-emergency-operation-plan-snapshot">
Call the K12 Safety REST API for snapshot metadata.

**Input**: `emergencyOperationPlanId` (string), `latest` (bool, default true), `limit` (number, default 1), `offset` (number, default 0)

**Output**: array of plan snapshot records validated against `emergencyOperationPlanSnapshotsOutputSchema`.
</Accordion>
</AccordionGroup>

## Annex tool endpoints (HTTP)

You call the Mastra tools over HTTP at `/api/tools/{toolId}/execute`, wrapping payloads as `{ "data": { ... } }`.

- **Auth (APIM dev):** client credentials against `https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token` with scope `api://k12-api-dev/.default`; headers `Authorization: Bearer {token}`, `Ocp-Apim-Subscription-Key: {subscription_key}`, `Content-Type: application/json`.
- **Base URL:** `https://aitools-dev-apim-k12.azure-api.net` (override with `ANNEX_BASE_URL` for other envs or local dev).
- **Core toolchain:** kickoff → status → result (optional cancel). All identifiers are UUID strings; omit `requestId/sessionId` to let the workflow generate them.

### Kickoff (enqueue)

`POST /api/tools/k12-annex-editing-kickoff/execute`

```bash
curl -X POST "$BASE/api/tools/k12-annex-editing-kickoff/execute" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Ocp-Apim-Subscription-Key: $SUB_KEY" \
  -H "Content-Type: application/json" \
  -d '{"data": {"emergencyOperationPlanId": "plan-123", "userId": "principal@example.edu", "roleId": "safety-coordinator", "form": {"field": {"content": "<p>Draft annex text</p>"}}, "prompt": "Rewrite in two bullets"}}'
```

Response (async):

```json
{ "requestId": "9fd2055d-42ab-4c29-bf0d-51bd8f7db3ec", "sessionId": "0e1a5e3f-3a3c-4d1f-bbc6-0e76b1c4a8c7", "status": "accepted" }
```

### Status (poll)

`POST /api/tools/k12-annex-editing-status/execute`

```bash
curl -X POST "$BASE/api/tools/k12-annex-editing-status/execute" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Ocp-Apim-Subscription-Key: $SUB_KEY" \
  -H "Content-Type: application/json" \
  -d '{"data": {"requestIds": ["9fd2055d-42ab-4c29-bf0d-51bd8f7db3ec"]}}'
```

```json
[{ "requestId": "9fd2055d-42ab-4c29-bf0d-51bd8f7db3ec", "sessionId": "0e1a5e3f-3a3c-4d1f-bbc6-0e76b1c4a8c7", "status": "processing" }]
```

### Result (fetch)

`POST /api/tools/k12-annex-editing-result/execute`

```bash
curl -X POST "$BASE/api/tools/k12-annex-editing-result/execute" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Ocp-Apim-Subscription-Key: $SUB_KEY" \
  -H "Content-Type: application/json" \
  -d '{"data": {"requestId": "9fd2055d-42ab-4c29-bf0d-51bd8f7db3ec"}}'
```

```json
{ "requestId": "9fd2055d-42ab-4c29-bf0d-51bd8f7db3ec", "sessionId": "0e1a5e3f-3a3c-4d1f-bbc6-0e76b1c4a8c7", "status": "success", "message": "<p>Edited annex text ...</p>", "isEdit": true }
```

### Cancel (optional)

`POST /api/tools/k12-cancel-task-request/execute`

```bash
curl -X POST "$BASE/api/tools/k12-cancel-task-request/execute" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Ocp-Apim-Subscription-Key: $SUB_KEY" \
  -H "Content-Type: application/json" \
  -d '{"data": {"requestId": "9fd2055d-42ab-4c29-bf0d-51bd8f7db3ec"}}'
```

```json
{ "status": "success" }
```

## Workflow semantics

- **IDs**: If callers omit `requestId` or `sessionId`, the workflow creates deterministic GUIDs. Provide both IDs when you need strict correlation across tables and clients.
- **Agent I/O**: The workflow builds a structured user message from plan identifiers, form field text, and prompt. The agent returns text plus JSON payload (`new_edition` or `answer`) and optional `is_edit`. LLM model/deployment and numeric knobs can be overridden via Agent Profiles.
- **Persistence**: Request logs capture normalized input and response payloads; monitoring rows record status transitions; job rows mirror workflow run state. All writes happen through the tools to keep schemas consistent.
- **Async behavior**: Kickoff returns `accepted` unless `waitForResult=true`, in which case it blocks until the workflow completes and returns `success` with the agent payload.
- **Cancellation**: When `K12_ENABLE_WORKFLOW_CANCELLATION=true`, the cancel tool attempts both workflow-handle cancellation and the Mastra API `/api/workflows/{id}/cancel`; it always marks DB rows as `cancelled` with a reason.

## External API dependencies

- **K12 Safety REST API**: `GET /documents/emergencyOperationPlans/snapshots` with `emergencyOperationPlanId(s)` plus `latest|limit|offset`. Headers may include bearer token, `Ocp-Apim-Subscription-Key`, and `X-Request-Id`.
- **SQL Server**: Tools use the SQL client to read/write `K12SAFETY` tables (`log_Jobs`, `log_EOP_TaskRequests`, `log_EOP_TaskStatus`).

## Configuration (conceptual)

- **K12 Safety API**: `K12_EOP_API_BASE_URL`, bearer or APIM keys (`K12_EOP_API_BEARER_TOKEN`, `K12_EOP_API_SUBSCRIPTION_KEY`), optional AAD client credentials (`K12_EOP_API_CLIENT_ID`, `K12_EOP_API_CLIENT_SECRET`, `K12_EOP_API_TENANT_ID`, `K12_EOP_API_SCOPE`); timeouts via `K12_EOP_API_TIMEOUT_MS` (default 10s).
- **Test overrides**: `K12_TEST_*` values fall back to `ANNEX_*` counterparts for integration tests and tool calls.
- **Workflow controls**: `K12_ENABLE_WORKFLOW_CANCELLATION` toggles cancellation; `MASTRA_TARGET` selects runtime; model overrides live in Agent Profiles; OpenAI and Content Safety providers follow the shared Mastra env contract.

## Integration checkpoints

- Pass both `requestId` and `sessionId` when you need strict correlation across logs and client state.
- Capture `workflowRunId` from kickoff responses if you will call workflow cancel endpoints directly.
- Use lookup tools for UI polling instead of hitting SQL directly; they enforce the same normalization and error messaging the workflow uses.
- Keep Content Safety and OpenAI provider env vars consistent with the shared Mastra config; the K12 agent uses those providers under the hood.
