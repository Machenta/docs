---
title: "EOP Internal Reference"
description: "Schemas, workflow steps, and data flows for K12 Safety (EOP annex editing)"
audience: ["dev"]
visibility: internal
---

<link rel="stylesheet" href="/styles.css" />

## Runtime surface

- **Target**: `MASTRA_TARGET=k12` loads the K12 agent, workflows, and tools.
- **Agent**: Registry `eop-k12-safety-agent`, profile `k12-safety-agent`. System prompt + LLM overrides (deployment/model/temperature/topP/penalties/maxOutputTokens) come from Agent Profiles.
- **Workflow**: `k12-annex-workflow` orchestrates kickoff → persistence → agent call → response writeback → status finalize; deterministic GUIDs keep retries idempotent.

## Workflow steps

<Steps>
<Step title="Normalize input">
Trim IDs, normalize optional fields, generate deterministic `requestId`/`sessionId` if absent.
</Step>
<Step title="Insert request log">
`k12-insert-task-request-log` writes to `K12SAFETY.log_EOP_TaskRequests` with request metadata, form, prompt, and raw JSON.
</Step>
<Step title="Insert monitoring row">
`k12-insert-task-in-monitoring-table` seeds `log_EOP_TaskStatus` (default `processing`).
</Step>
<Step title="Run agent">
Build user message (plan, form, prompt) → call K12 agent → expect `text` plus payload fields like `new_edition` or `answer` and optional `is_edit`.
</Step>
<Step title="Persist response">
`k12-update-task-request-response` sets `ResponseStatus`, `ResponseMessage`, `ResponseIsEdit`, `ResponsePayloadJson`, `RawResponseJson` on the request row.
</Step>
<Step title="Finalize status">
`k12-update-task-status` marks monitoring rows `success` or `error`; history captured in workflow state. Cancel path marks rows `cancelled`.
</Step>
</Steps>

## Tool catalog (detailed)

<AccordionGroup>
<Accordion title="k12-annex-editing-kickoff">
Validates form/prompt input, inserts a job row, starts the annex workflow; optional sync wait.

**Input schema**
- `emergencyOperationPlanId` (string, required)
- `emergencyOperationPlanConfigurationId` (string, optional)
- `userId`, `roleId` (strings, required)
- `form.name` (string, optional)
- `form.field.group | name | content` (strings, optional; `content` may be empty to indicate prompt-only)
- `prompt` (string, optional)
- `requestId`, `sessionId` (UUID strings, optional; generated if omitted)
- `waitForResult` (boolean, optional)

**Output**
- `accepted` → `requestId`, `sessionId`, optional `workflowRunId`, `message`
- `success` (when waiting) → `statusHistory[]`, `agentResponse { text, raw?, payload? }`, `responsePayloadJson`, `requestLogId`, `monitoringRowId`, `responseStatus`, `isEdit`, `message`
</Accordion>

<Accordion title="k12-annex-editing-status">
Reads `log_Jobs` rows by `requestIds`.

**Input**: `requestIds[]`

**Output**: array `{ requestId, sessionId, status }`
</Accordion>

<Accordion title="k12-annex-editing-result">
Reads final payload from `log_Jobs`.

**Input**: `requestId`

**Output**: `{ requestId, sessionId, status, message, isEdit }`
</Accordion>

<Accordion title="k12-insert-task-request-log">
Writes normalized payload to `log_EOP_TaskRequests`.

**Input**
- `taskName` (default "K12 Annex Workflow")
- `requestId`, `sessionId` (required)
- `emergencyOperationPlanId`, `emergencyOperationPlanConfigurationId`, `userId`, `roleId` (optional)
- `form.name`, `form.field.group|name|content` (optional)
- `prompt`, `workflowRunId` (optional)

**Output**: inserted row with nullable response fields.
</Accordion>

<Accordion title="k12-insert-task-in-monitoring-table">
Writes monitoring row to `log_EOP_TaskStatus`.

**Input**: `taskName`, `sessionId`, `requestId`, `status` (accepted|processing|success|error|cancelled), `message?`, `workflowRunId?`

**Output**: inserted monitoring row.
</Accordion>

<Accordion title="k12-update-task-request-response">
Updates request log with model response.

**Input**: `requestId`, `sessionId`, `responseStatus` (default "success"), `responseMessage`, `responseIsEdit?`, `rawResponseJson?`, `responsePayloadJson?`

**Output**: updated request row with response fields.
</Accordion>

<Accordion title="k12-update-task-status">
Updates monitoring status.

**Input**: `sessionId`, `requestId`, `status` (accepted|processing|success|error|cancelled)

**Output**: updated monitoring row.
</Accordion>

<Accordion title="k12-cancel-task-request">
Marks request + status rows as cancelled; if `K12_ENABLE_WORKFLOW_CANCELLATION=true`, attempts workflow-handle and API cancellation.

**Input**: `requestId`

**Output**: `{ status: "success" | "error", message? }`
</Accordion>

<Accordion title="k12-lkp-task-status-by-session-or-request">
Fetch latest status from `log_EOP_TaskStatus`.

**Input**: `requestId` (required), `sessionId?`

**Output**: `{ requestId, sessionId, status }`
</Accordion>

<Accordion title="k12-lkp-task-request-result">
Fetch latest response from `log_EOP_TaskRequests`.

**Input**: `requestId` (required), `sessionId?`

**Output**: `{ requestId, sessionId, status, message, isEdit } | null`
</Accordion>

<Accordion title="k12-get-emergency-operation-plan-snapshot">
Calls K12 Safety REST API for snapshot metadata.

**Input**: `emergencyOperationPlanId` (string), `latest` (bool, default true), `limit` (number, default 1), `offset` (number, default 0)

**Output**: array of plan snapshot records (validated against `emergencyOperationPlanSnapshotsOutputSchema`).
</Accordion>
</AccordionGroup>

## Data plane

<AccordionGroup>
<Accordion title="K12SAFETY.log_Jobs">
- Job tracking for kickoff; columns: `request_id`, `session_id`, `workflow_run_id`, `job_type`, `job_description`, `status`, `result_payload`, `error`, timestamps.
- Kickoff inserts `processing`; status tool reports from here.
</Accordion>
<Accordion title="K12SAFETY.log_EOP_TaskRequests">
- Request + response log; columns include `TaskName`, `RequestID`, `SessionID`, plan IDs, user/role, form fields, `RequestPrompt`, `ResponseStatus`, `ResponseMessage`, `ResponseIsEdit`, `ResponsePayloadJson`, `RawRequestJson`, `RawResponseJson`, timestamps.
- Insert tool seeds; update-response tool populates response fields.
</Accordion>
<Accordion title="K12SAFETY.log_EOP_TaskStatus">
- Monitoring rows; columns `TaskName`, `SessionID`, `RequestID`, `WorkflowRunId`, `Status`, `Message`, timestamps.
- Insert monitoring + update status tools write here.
</Accordion>
</AccordionGroup>

## Status and IDs

- Status vocabulary: `accepted`, `processing`, `success`, `error`, `cancelled` (typo handling maps `sucess` → `success`, `canceled` → `cancelled`).
- Provide `requestId` + `sessionId` for strict correlation; workflow generates deterministic GUIDs if omitted.

## Tool technical notes

These are pragmatic details to watch for when integrating the K12 annex toolchain or building clients that interact with the tools.

- **Identifiers and correlation**: Provide both `requestId` and `sessionId` when you need strict correlation across database tables and clients. When not provided, the workflow generates deterministic GUIDs based on the normalized input; this guarantees idempotency for identical inputs but means the generated `requestId`/`sessionId` are deterministic and stable only for the same payload.

- **Async vs Sync behavior**: The kickoff tool supports both asynchronous and synchronous usage. When `waitForResult=true`, the kickoff call blocks until the workflow completes and returns a `success` result (or throws on failure). For most UI integrations use async fire-and-forget (`waitForResult=false`) and poll `k12-annex-editing-status` or `k12-annex-editing-result` to avoid long request timeouts.

- **Cancellation behavior**: When `K12_ENABLE_WORKFLOW_CANCELLATION=true`, the cancel tool attempts both in-memory workflow handle cancellation and the Mastra API cancel endpoint; the tool still marks DB rows as `cancelled` in all cases. When disabled, cancellation still marks DB rows as `cancelled` but does not attempt workflow-run cancellation.

- **Plan snapshot paging**: The snapshot tool defaults to `latest=true` and `limit=1`. Use `latest=false`, `limit`, and `offset` parameters for broader retrievals. The tool accepts single or plural plan IDs depending on API compatibility; pass `emergencyOperationPlanId` to target a single plan.

- **Content and output fields**: The agent returns `text` and may return structured payload fields such as `answer` or `new_edition`. Persisted fields include `ResponseStatus`, `ResponseMessage`, `ResponseIsEdit`, `ResponsePayloadJson`, and `RawResponseJson` — treat `responsePayloadJson` as the source of structured edits and `ResponseMessage` as a human-readable summary.

## Configuration

- Workflow cancellation toggle: `K12_ENABLE_WORKFLOW_CANCELLATION` (enables handle + API cancellation attempts).
- K12 Safety API: `K12_EOP_API_BASE_URL`, bearer/APIM keys (`K12_EOP_API_BEARER_TOKEN`, `K12_EOP_API_SUBSCRIPTION_KEY`), optional AAD client credentials (`K12_EOP_API_CLIENT_ID`, `K12_EOP_API_CLIENT_SECRET`, `K12_EOP_API_TENANT_ID`, `K12_EOP_API_SCOPE`), timeout `K12_EOP_API_TIMEOUT_MS` (default 10s).
- Test overrides: `K12_TEST_*` fall back to `ANNEX_*`.
- Model overrides: via Agent Profiles record for `k12-safety-agent`.
- Content safety/OpenAI: use shared Mastra provider envs (Azure OpenAI + Azure Content Safety) per platform guidance.

## Integration tips

- Always write through the tools (not direct SQL) to keep normalization consistent.
- Capture `workflowRunId` from kickoff if you intend to call workflow cancel endpoints directly.
- Treat `responsePayloadJson` as the structured edit payload; `ResponseMessage` is user-facing text.
- For retries with identical inputs, deterministic GUIDs prevent duplicate rows.
